//
// Created by Ghala Buarish on 8/1/25.
//

#include "ELL_spmv.h"

#include <hls_stream.h>
#include <ap_axi_sdata.h>

void spmv_ell(hls::stream<DTYPE> &in_fifo, hls::stream<DTYPE> &out_fifo) {

#pragma HLS INTERFACE axis port = in_fifo
#pragma HLS INTERFACE axis port = out_fifo
#pragma HLS INTERFACE mode=ap_ctrl_hs port=return

	DTYPE ell_values[ROWS][MAX_NNZ];
	int ell_col_index[ROWS][MAX_NNZ];
	DTYPE x[ROWS];


	for (int i = 0; i < ROWS; i++) {
		for (int j = 0; j < MAX_NNZ; j++) {
			ell_values[i][j] = in_fifo.read();
		}
	}
	for (int i = 0; i < ROWS; i++) {
		for (int j = 0; j < MAX_NNZ; j++) {
			ell_col_index[i][j] = in_fifo.read();
		}
	}
	for (int i = 0; i < ROWS; i++) {
		x[i] = in_fifo.read();
	}



	L1: for (int i = 0; i < ROWS; i++) {
		DTYPE y0 = 0;
		L2:for (int j = 0; j < MAX_NNZ; j++) {
			int col = ell_col_index[i][j];
			if (col != 0xFFFFFFFF) {
				y0 += ell_values[i][j] * x[col];
			}
		}
		out_fifo.write(y0);
	}
}


tb:

//
// Created by Ghala Buarish on 8/1/25.
//
#include "ELL_spmv.h"
#include <stdio.h>
#include <iostream>

int main() {
	hls::stream<DTYPE> y;
	// ell_values = {{3, 4, 0}
	//				{5, 9, 0}
	//				{2, 3, 1}
	//				{4, 6, 0}}
	// ell_vol_index = {{0, 1, -1}
	//				   {1, 2, -1}
	//				   {0, 2, 3}
	//				   {1, 3, -1}}

	hls::stream<DTYPE> input;


	DTYPE inputData[TOTAL] = {
			3, 4, 0,
			5, 9, 0,
			2, 3, 1,
			4, 6, 0,

			0, 1, 4294967295,
			1, 2, 4294967295,
			0, 2, 3,
			1, 3, 4294967295,

			1, 2, 3, 4 //x
	};


	for (int i=0; i<TOTAL; i++){
		input.write(inputData[i]);
	}
	spmv_ell(input, y);


	for (int i = 0; i < ROWS; i++) {
		printf("y[%d] = %f\n", i, y.read());
	}
	return 0;
}


